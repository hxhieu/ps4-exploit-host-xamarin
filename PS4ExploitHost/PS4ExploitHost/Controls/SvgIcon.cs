using System;
using System.Windows.Input;
using PS4ExploitHost.Common.Interfaces;
using SkiaSharp;
using SkiaSharp.Views.Forms;
using Xamarin.Forms;
using static PS4ExploitHost.Common.Constants;
using Svg = SkiaSharp.Extended.Svg.SKSvg;

namespace PS4ExploitHost.Controls
{
    public class SvgIcon : Frame
    {
        readonly SKCanvasView _canvasView = new SKCanvasView
        {
            IgnorePixelScaling = true
        };

        static readonly TapGestureRecognizer _tapGesture = new TapGestureRecognizer();

        readonly IAssetLoader _assetLoader;

        public static readonly BindableProperty IconFilePathProperty = BindableProperty.Create(
            nameof(Name),
            typeof(string),
            typeof(SvgIcon),
            default(string),
            propertyChanged: RedrawCanvas);

        public static readonly BindableProperty IconColourProperty = BindableProperty.Create(
           nameof(Colour),
           typeof(string),
           typeof(SvgIcon),
           "#ffffff",
           propertyChanged: RedrawCanvas);

        public static readonly BindableProperty TapCommandProperty = BindableProperty.Create(
            nameof(TapCommand),
           typeof(ICommand),
           typeof(SvgIcon),
           null,
            propertyChanged: UpdateTapCommand);

        static void UpdateTapCommand(BindableObject bindable, object oldValue, object newValue)
        {
            var svgIcon = bindable as SvgIcon;
            if (svgIcon.TapCommand != null)
            {
                _tapGesture.Command = svgIcon.TapCommand;
            }
        }

        public string Name
        {
            get => (string)GetValue(IconFilePathProperty);
            set => SetValue(IconFilePathProperty, value);
        }

        public string Colour
        {
            get => (string)GetValue(IconColourProperty);
            set => SetValue(IconColourProperty, value);
        }

        public ICommand TapCommand
        {
            get => (ICommand)GetValue(TapCommandProperty);
            set => SetValue(TapCommandProperty, value);
        }

        static void RedrawCanvas(BindableObject bindable, object oldvalue, object newvalue)
        {
            var svgIcon = bindable as SvgIcon;
            svgIcon?._canvasView.InvalidateSurface();
        }

        public SvgIcon()
        {
            _assetLoader = DependencyService.Get<IAssetLoader>();

            Padding = new Thickness(0);
            HasShadow = false;
            BackgroundColor = Color.Transparent;
            WidthRequest = HeightRequest = 60;

            Content = _canvasView;

            GestureRecognizers.Add(_tapGesture);

            _canvasView.PaintSurface += CanvasViewOnPaintSurface;

        }

        void CanvasViewOnPaintSurface(object sender, SKPaintSurfaceEventArgs args)
        {
            var canvas = args.Surface.Canvas;
            canvas.Clear();

            if (string.IsNullOrEmpty(Name))
                return;

            using (var stream = _assetLoader.Load(AssetType.Svgs, Name))
            {
                var svg = new Svg();
                svg.Load(stream);

                using (var paint = new SKPaint())
                {
                    var matrix = SKMatrix.MakeScale((float)WidthRequest / svg.CanvasSize.Width, (float)HeightRequest / svg.CanvasSize.Height);
                    paint.ColorFilter = SKColorFilter.CreateBlendMode(SKColor.Parse(Colour), SKBlendMode.SrcIn);
                    canvas.DrawPicture(svg.Picture, ref matrix, paint);
                }
            }
        }
    }
}

